<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>管理員後台</title>
    <style>
        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', Arial, sans-serif;
            background-color: #f4f7f6;
            margin: 0;
            padding: 2rem;
        }
        .container {
            max-width: 1200px;
            margin: auto;
            background-color: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 1rem;
            margin-bottom: 2rem;
        }
        .header h1 { margin: 0; font-size: 1.8rem; }
        .logout-button {
            padding: 0.6rem 1.2rem; background-color: #dc3545; color: white;
            text-decoration: none; border-radius: 5px; font-size: 0.9rem;
            border: none; cursor: pointer; transition: background-color 0.2s;
        }
        .logout-button:hover { background-color: #c82333; }
        .tab-nav { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 2rem; }
        .tab-button, .tab-link {
            padding: 1rem 1.5rem; cursor: pointer; border: none;
            background-color: transparent; font-size: 1rem; color: #555;
            position: relative; top: 2px;
            text-decoration: none;
        }
        .tab-button.active {
            font-weight: bold; color: #007bff; border-bottom: 2px solid #007bff;
        }
        .tab-link:hover { color: #0056b3; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s; }
        h2 { color: #333; border-bottom: 1px solid #eee; padding-bottom: 0.5rem; margin-top: 0; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .actions-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .search-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        .search-controls input, .search-controls select {
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        .search-controls button {
            padding: 8px 20px;
            border: none;
            border-radius: 4px;
            background-color: #007bff;
            color: white;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .search-controls button:hover { background-color: #0056b3; }
        .btn-add, .btn-edit, .btn-import, .btn-delete {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            font-size: 0.85rem;
            text-decoration: none;
            display: inline-block;
        }
        .btn-add { background-color: #28a745; }
        .btn-add:hover { background-color: #218838; }
        .btn-edit { background-color: #ffc107; color: #212529; }
        .btn-edit:hover { background-color: #e0a800; }
        .btn-import { background-color: #17a2b8; }
        .btn-import:hover { background-color: #117a8b; }
        .btn-delete { background-color: #dc3545; }
        .btn-delete:hover { background-color: #c82333; }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { padding: 12px 15px; border: 1px solid #ddd; text-align: left; font-size: 0.9rem; }
        td { max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        td.translations, td.translated-desc { white-space: normal; }
        th { background-color: #f8f9fa; font-weight: bold; color: #333; white-space: nowrap; }
        tbody tr:nth-child(even) { background-color: #f2f2f2; }
        tbody tr:hover { background-color: #e9ecef; }
        .pagination-controls { display: flex; justify-content: center; align-items: center; margin-top: 2rem; }
        .pagination-button {
            padding: 8px 16px; margin: 0 4px; border: 1px solid #ddd; background-color: white;
            color: #007bff; cursor: pointer; border-radius: 4px;
        }
        .pagination-button:hover:not(:disabled) { background-color: #e9ecef; }
        .pagination-button:disabled { color: #aaa; cursor: not-allowed; }
        .pagination-info { margin: 0 16px; font-size: 0.9rem; color: #555; }
        .flash-message-success {
            padding: 1rem; background-color: #d4edda; color: #155724;
            border: 1px solid #c3e6cb; border-radius: 4px;
            margin-bottom: 1.5rem; text-align: center;
        }
        .flash-message-error {
            padding: 1rem; background-color: #f8d7da; color: #721c24;
            border: 1px solid #f5c6cb; border-radius: 4px;
            margin-bottom: 1.5rem; text-align: center;
        }
        .menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .menu-selector {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .menu-selector label { font-weight: bold; }
        .menu-selector select {
            min-width: 250px;
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>歡迎，{{ username }}！</h1>
            <form action="{{ url_for('logout') }}" method="get">
                <button type="submit" class="logout-button">登出</button>
            </form>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="flash-message-{{ category or 'success' }}">{{ message }}</div>
            {% endfor %}
          {% endif %}
        {% endwith %}

        <div class="tab-nav">
            <button class="tab-button active" onclick="openTab(event, 'store-info')">店家資訊</button>
            <button class="tab-button" onclick="openTab(event, 'menu-content')">菜單內容</button>
            <button class="tab-button" onclick="openTab(event, 'ocr-menu-content')">OCR菜單管理</button>
            <button class="tab-button" onclick="openTab(event, 'languages-maintenance')">語系維護</button>
            <button class="tab-button" onclick="openTab(event, 'store-user-binding')">人店綁定</button>
        </div>

        <div id="store-info" class="tab-content active">
            <h2>店家列表</h2>
            <div class="actions-bar">
                <div class="search-controls">
                    <input type="text" id="search-name" placeholder="輸入店家名稱...">
                    <select id="search-level">
                        <option value="">全部等級</option>
                        <option value="2">VIP</option>
                        <option value="1">合作</option>
                        <option value="0">非合作</option>
                    </select>
                    <button id="search-button">搜尋</button>
                </div>
                <a href="{{ url_for('add_store') }}" class="btn-add">新增店家</a>
            </div>
            <div class="table-container">
                <table id="stores-table">
                    <thead>
                        <tr>
                            <th>操作</th><th>店家 ID</th><th>店家名稱</th><th>合作等級</th><th>建立時間</th>
                            <th>評論摘要</th><th>人氣菜色 1</th><th>人氣菜色 2</th><th>人氣菜色 3</th>
                            <th>人氣菜色 4</th><th>人氣菜色 5</th><th>照片 URL</th><th>緯度</th>
                            <th>經度</th><th>Place ID</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="15" style="text-align:center;">正在載入資料...</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="pagination-controls" id="pagination-controls"></div>
        </div>

        <div id="menu-content" class="tab-content">
            <h2>菜單項目管理</h2>
            <div class="menu-header">
                <div class="menu-selector">
                    <label for="store-select">選擇店家：</label>
                    <select id="store-select">
                        <option value="">-- 請選擇一家店 --</option>
                    </select>
                </div>
                <a id="add-menu-item-btn" href="#" class="btn-add" style="display:none;">新增品項</a>
            </div>
            <div class="table-container" id="menu-items-container">
                <table id="menu-items-table">
                    <thead>
                        <tr>
                            <th>操作</th>
                            <th>品項名稱</th>
                            <th>大份價格</th>
                            <th>小份價格</th>
                            <th>多語言描述</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="5" style="text-align:center;">請先選擇一家店來查看菜單。</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="ocr-menu-content" class="tab-content">
            <div class="actions-bar">
                <h2>OCR 菜單管理</h2>
                <a href="{{ url_for('upload_ocr') }}" class="btn-add">上傳菜單</a>
            </div>
            <div class="menu-selector">
                <label for="ocr-store-select">選擇店家：</label>
                <select id="ocr-store-select">
                    <option value="">-- 請選擇一家店 --</option>
                </select>
                <a id="add-ocr-menu-item-btn" href="#" class="btn-add" style="display: none; margin-left: 1rem;">新增OCR品項</a>
                <form id="import-ocr-form" action="{{ url_for('import_ocr_menu') }}" method="post" style="display: inline-block; margin-left: 1rem;">
                    <input type="hidden" name="ocr_store_name" id="ocr-store-name-hidden">
                    <button type="submit" id="import-ocr-btn" class="btn-import" style="display: none;">匯入此店家菜單</button>
                </form>
                </div>
            <div class="table-container">
                <table id="ocr-menu-items-table">
                    <thead>
                        <tr>
                            <th>操作</th>
                            <th>品項名稱</th>
                            <th>大份價格</th>
                            <th>小份價格</th>
                            <th>翻譯後介紹</th>
                            <th>多語言描述</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="6" style="text-align:center;">請先選擇一家店來查看 OCR 菜單。</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="languages-maintenance" class="tab-content">
            <h2>語系維護</h2>
            <div class="actions-bar">
                <div class="search-controls">
                    <input type="text" id="lang-search-input" placeholder="搜尋代碼或名稱...">
                </div>
                <button class="btn-add" onclick="openLanguageModal()">新增語系</button>
            </div>
            <div class="table-container">
                <table id="languages-table">
                    <thead>
                        <tr>
                            <th>Line 語言代碼</th>
                            <th>語言名稱</th>
                            <th>翻譯語言代碼</th>
                            <th>STT 語言代碼</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="5" style="text-align:center;">正在載入資料...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="store-user-binding" class="tab-content">
            <div class="actions-bar">
                <h2>人店綁定列表</h2>
                <a href="{{ url_for('add_store_user_link') }}" class="btn-add">新增綁定</a>
            </div>
            <div class="table-container">
                <table id="links-table">
                    <thead>
                        <tr>
                            <th>店家名稱</th>
                            <th>使用者名稱</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="3" style="text-align:center;">正在載入綁定資料...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        function openTab(event, tabName) {
            let i, tabContents, tabButtons;
            tabContents = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabContents.length; i++) { tabContents[i].classList.remove("active"); }
            
            const tabLinks = document.querySelectorAll(".tab-button, .tab-link");
            for (i = 0; i < tabLinks.length; i++) { tabLinks[i].classList.remove("active"); }

            const activeTab = document.getElementById(tabName);
            if (activeTab) {
                activeTab.classList.add("active");
            }
            event.currentTarget.classList.add("active");

            if (tabName === 'languages-maintenance') {
                fetchLanguages();
            }
            if (tabName === 'ocr-menu-content' && document.getElementById('ocr-store-select').options.length <= 1) {
                populateOcrStoreSelector();
            }
            if (tabName === 'store-user-binding') {
                fetchLinks();
            }
        }

        const storesTableBody = document.querySelector("#stores-table tbody");
        const paginationControls = document.getElementById("pagination-controls");
        const searchNameInput = document.getElementById("search-name");
        const searchLevelSelect = document.getElementById("search-level");
        const searchButton = document.getElementById("search-button");

        async function fetchStores(page = 1) {
            const searchName = searchNameInput.value;
            const searchLevel = searchLevelSelect.value;
            storesTableBody.innerHTML = `<tr><td colspan="15" style="text-align:center;">正在載入資料...</td></tr>`;
            const apiUrl = `/api/stores?page=${page}&name=${encodeURIComponent(searchName)}&level=${encodeURIComponent(searchLevel)}`;
            try {
                const response = await fetch(apiUrl);
                if (!response.ok) { throw new Error(`HTTP 錯誤! 狀態: ${response.status}`); }
                const data = await response.json();
                renderTable(data.stores);
                renderPagination(data.pagination);
            } catch (error) {
                console.error("無法取得店家資料:", error);
                storesTableBody.innerHTML = `<tr><td colspan="15" style="text-align:center; color: red;">無法載入資料。</td></tr>`;
            }
        }

        function renderTable(stores) {
            storesTableBody.innerHTML = "";
            if (!stores || stores.length === 0) {
                storesTableBody.innerHTML = `<tr><td colspan="15" style="text-align:center;">找不到符合條件的店家資料。</td></tr>`;
                return;
            }
            stores.forEach(store => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td><a href="/edit_store/${store.store_id}" class="btn-edit">修改</a></td>
                    <td>${store.store_id}</td><td>${store.store_name || ''}</td>
                    <td>${getPartnerLevelText(store.partner_level)}</td><td>${formatDate(store.created_at)}</td>
                    <td title="${store.review_summary || ''}">${store.review_summary || ''}</td>
                    <td>${store.top_dish_1 || ''}</td><td>${store.top_dish_2 || ''}</td>
                    <td>${store.top_dish_3 || ''}</td><td>${store.top_dish_4 || ''}</td>
                    <td>${store.top_dish_5 || ''}</td>
                    <td>${store.main_photo_url ? `<a href="${store.main_photo_url}" target="_blank">連結</a>` : ''}</td>
                    <td>${store.gps_lat || ''}</td><td>${store.gps_lng || ''}</td>
                    <td>${store.place_id || ''}</td>
                `;
                storesTableBody.appendChild(row);
            });
        }

        function renderPagination(pagination) {
            paginationControls.innerHTML = "";
            if (!pagination || pagination.total_pages <= 1) return;
            const prevButton = document.createElement("button");
            prevButton.innerText = "上一頁";
            prevButton.className = "pagination-button";
            prevButton.disabled = !pagination.has_prev;
            prevButton.onclick = () => fetchStores(pagination.current_page - 1);
            paginationControls.appendChild(prevButton);
            const pageInfo = document.createElement("span");
            pageInfo.className = "pagination-info";
            pageInfo.innerText = `第 ${pagination.current_page} / ${pagination.total_pages} 頁`;
            paginationControls.appendChild(pageInfo);
            const nextButton = document.createElement("button");
            nextButton.innerText = "下一頁";
            nextButton.className = "pagination-button";
            nextButton.disabled = !pagination.has_next;
            nextButton.onclick = () => fetchStores(pagination.current_page + 1);
            paginationControls.appendChild(nextButton);
        }

        const storeSelect = document.getElementById('store-select');
        const menuItemsTableBody = document.querySelector('#menu-items-table tbody');
        const addMenuItemBtn = document.getElementById('add-menu-item-btn');

        async function populateStoreSelector() {
            try {
                const response = await fetch('/api/all_stores');
                const stores = await response.json();
                storeSelect.innerHTML = '<option value="">-- 請選擇一家店 --</option>';
                stores.forEach(store => {
                    const option = document.createElement('option');
                    option.value = store.store_id;
                    option.textContent = `${store.store_id}: ${store.store_name}`;
                    storeSelect.appendChild(option);
                });
            } catch (error) {
                console.error('無法載入店家列表:', error);
            }
        }

        async function fetchMenuItems(storeId) {
            if (!storeId) {
                menuItemsTableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">請先選擇一家店來查看菜單。</td></tr>';
                if(addMenuItemBtn) addMenuItemBtn.style.display = 'none';
                return;
            }
            if(addMenuItemBtn) {
                addMenuItemBtn.href = `/add_menu_item/${storeId}`;
                addMenuItemBtn.style.display = 'inline-block';
            }
            
            menuItemsTableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">正在載入菜單...</td></tr>';
            try {
                const response = await fetch(`/api/menu_items/${storeId}`);
                const items = await response.json();
                renderMenuTable(items);
            } catch (error) {
                console.error('無法載入菜單項目:', error);
                menuItemsTableBody.innerHTML = '<tr><td colspan="5" style="text-align:center; color: red;">無法載入菜單。</td></tr>';
            }
        }

        function renderMenuTable(items) {
            menuItemsTableBody.innerHTML = '';
            if (!items || items.length === 0) {
                menuItemsTableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">這家店目前沒有菜單資料。</td></tr>';
                return;
            }
            items.forEach(item => {
                const row = document.createElement('tr');
                let translationsHtml = '';
                if (item.translations && item.translations.length > 0) {
                    translationsHtml = item.translations
                        .map(t => `<b>${t.lang_name}:</b> ${t.description}`)
                        .join('<br>');
                } else {
                    translationsHtml = '-';
                }

                row.innerHTML = `
                    <td><a href="/edit_menu_item/${item.menu_item_id}" class="btn-edit">修改</a></td>
                    <td>${item.item_name}</td>
                    <td>${item.price_big !== null ? item.price_big : '-'}</td>
                    <td>${item.price_small}</td>
                    <td class="translations">${translationsHtml}</td>
                `;
                menuItemsTableBody.appendChild(row);
            });
        }
        
        const ocrStoreSelect = document.getElementById('ocr-store-select');
        const ocrMenuItemsTableBody = document.querySelector('#ocr-menu-items-table tbody');
        const importBtn = document.getElementById('import-ocr-btn');
        const importForm = document.getElementById('import-ocr-form');
        const hiddenInput = document.getElementById('ocr-store-name-hidden');
        // *** 修改處 START ***
        const addOcrMenuItemBtn = document.getElementById('add-ocr-menu-item-btn');
        // *** 修改處 END ***

        importForm.addEventListener('submit', function(event) {
            if (!confirm('確定要將此 OCR 菜單匯入到正式菜單嗎？\n\n- 系統會檢查店家是否存在。\n- 所有此 OCR 菜單的品項都將被新增至正式菜單中。\n\n此操作無法復原！')) {
                event.preventDefault();
            }
        });

        async function populateOcrStoreSelector() {
            try {
                const response = await fetch('/api/ocr_store_names');
                const storeNames = await response.json();
                ocrStoreSelect.innerHTML = '<option value="">-- 請選擇一家店 --</option>';
                storeNames.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    ocrStoreSelect.appendChild(option);
                });
            } catch (error) {
                console.error('無法載入 OCR 店家列表:', error);
            }
        }

        // *** 修改處 START ***
        async function fetchOcrMenuItems(storeName) {
            if (storeName) {
                importBtn.style.display = 'inline-block';
                hiddenInput.value = storeName;
                if (addOcrMenuItemBtn) {
                    addOcrMenuItemBtn.style.display = 'inline-block';
                    addOcrMenuItemBtn.href = `/add_ocr_menu_item?store_name=${encodeURIComponent(storeName)}`;
                }
            } else {
                importBtn.style.display = 'none';
                hiddenInput.value = '';
                if (addOcrMenuItemBtn) {
                    addOcrMenuItemBtn.style.display = 'none';
                }
            }
        // *** 修改處 END ***
            
            if (!storeName) {
                ocrMenuItemsTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">請先選擇一家店來查看 OCR 菜單。</td></tr>';
                return;
            }

            ocrMenuItemsTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">正在載入 OCR 菜單...</td></tr>';
            try {
                const response = await fetch(`/api/ocr_menus/${encodeURIComponent(storeName)}`);
                const items = await response.json();
                renderOcrMenuTable(items);
            } catch (error) {
                console.error('無法載入 OCR 菜單項目:', error);
                ocrMenuItemsTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center; color: red;">無法載入 OCR 菜單。</td></tr>';
            }
        }

        function renderOcrMenuTable(items) {
            ocrMenuItemsTableBody.innerHTML = '';
            if (!items || items.length === 0) {
                ocrMenuItemsTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">這家店目前沒有 OCR 菜單資料。</td></tr>';
                return;
            }
            items.forEach(item => {
                const row = document.createElement('tr');
                let translationsHtml = '';
                if (item.translations && item.translations.length > 0) {
                    translationsHtml = item.translations
                        .map(t => `<b>${t.lang_name}:</b> ${t.description}`)
                        .join('<br>');
                } else {
                    translationsHtml = '-';
                }
                
                row.innerHTML = `
                    <td><a href="/edit_ocr_menu_item/${item.ocr_menu_item_id}" class="btn-edit">修改</a></td>
                    <td>${item.item_name}</td>
                    <td>${item.price_big !== null ? item.price_big : '-'}</td>
                    <td>${item.price_small}</td>
                    <td class="translated-desc">${item.translated_desc || ''}</td>
                    <td class="translations">${translationsHtml}</td>
                `;
                ocrMenuItemsTableBody.appendChild(row);
            });
        }

        const langSearchInput = document.getElementById('lang-search-input');
        const languagesTableBody = document.querySelector('#languages-table tbody');

        async function fetchLanguages() {
            const searchTerm = langSearchInput.value;
            languagesTableBody.innerHTML = `<tr><td colspan="5" style="text-align:center;">正在載入資料...</td></tr>`;
            try {
                const response = await fetch(`/api/languages?search=${encodeURIComponent(searchTerm)}`);
                const languages = await response.json();
                renderLanguagesTable(languages);
            } catch (error) {
                console.error('無法載入語系資料:', error);
                languagesTableBody.innerHTML = `<tr><td colspan="5" style="text-align:center; color: red;">無法載入語系資料。</td></tr>`;
            }
        }

        function renderLanguagesTable(languages) {
            languagesTableBody.innerHTML = '';
            if (!languages || languages.length === 0) {
                languagesTableBody.innerHTML = `<tr><td colspan="5" style="text-align:center;">找不到符合條件的語系資料。</td></tr>`;
                return;
            }
            languages.forEach(lang => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${lang.line_lang_code || ''}</td>
                    <td>${lang.lang_name || ''}</td>
                    <td>${lang.translation_lang_code || ''}</td>
                    <td>${lang.stt_lang_code || ''}</td>
                    <td><button class="btn-edit" onclick="openLanguageModal(
                        '${lang.line_lang_code || ''}', 
                        '${lang.lang_name || ''}', 
                        '${lang.translation_lang_code || ''}', 
                        '${lang.stt_lang_code || ''}'
                    )">修改</button></td>
                `;
                languagesTableBody.appendChild(row);
            });
        }

        function openLanguageModal(line_code = '', name = '', trans_code = '', stt_code = '') {
            const isEdit = !!line_code;
            const title = isEdit ? '修改語系' : '新增語系';
            const codeInput = isEdit 
                ? `<input type="text" id="line-code-modal" value="${line_code}" disabled>` 
                : `<input type="text" id="line-code-modal" required>`;
            
            const modalHtml = `
                <div id="language-modal-backdrop" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1001;">
                    <div id="language-modal-content" style="background: white; padding: 2rem; border-radius: 8px; width: 400px; display: flex; flex-direction: column; gap: 1rem;">
                        <h3>${title}</h3>
                        <div><label>Line 語言代碼</label>${codeInput}</div>
                        <div><label>語言名稱</label><input type="text" id="lang-name-modal" value="${name}" required></div>
                        <div><label>翻譯語言代碼</label><input type="text" id="trans-code-modal" value="${trans_code}" required></div>
                        <div><label>STT 語言代碼</label><input type="text" id="stt-code-modal" value="${stt_code}" required></div>
                        <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1rem;">
                            <button onclick="document.getElementById('language-modal-backdrop').remove()">取消</button>
                            <button id="save-lang-btn">儲存</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            document.getElementById('save-lang-btn').onclick = async () => {
                const payload = {
                    line_lang_code: document.getElementById('line-code-modal').value,
                    lang_name: document.getElementById('lang-name-modal').value,
                    translation_lang_code: document.getElementById('trans-code-modal').value,
                    stt_lang_code: document.getElementById('stt-code-modal').value
                };

                if (!payload.line_lang_code || !payload.lang_name || !payload.translation_lang_code || !payload.stt_lang_code) {
                    alert('所有欄位皆為必填！');
                    return;
                }

                const url = isEdit ? '/api/languages/edit' : '/api/languages/add';

                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();
                    if (response.ok) {
                        document.getElementById('language-modal-backdrop').remove();
                        fetchLanguages();
                    } else {
                        alert(`錯誤: ${result.error}`);
                    }
                } catch(error) {
                    console.error("儲存語系時發生錯誤:", error);
                    alert("儲存失敗，請檢查網路連線或後端服務。");
                }
            };
        }

        const linksTableBody = document.querySelector('#links-table tbody');

        async function fetchLinks() {
            if (!linksTableBody) return;
            linksTableBody.innerHTML = '<tr><td colspan="3" style="text-align:center;">正在載入綁定資料...</td></tr>';
            try {
                const response = await fetch('/api/store_user_links');
                if (!response.ok) throw new Error('Network response was not ok');
                const links = await response.json();
                renderLinksTable(links);
            } catch (error) {
                console.error('無法載入綁定資料:', error);
                linksTableBody.innerHTML = '<tr><td colspan="3" style="text-align:center; color: red;">無法載入綁定資料。</td></tr>';
            }
        }

        function renderLinksTable(links) {
            if (!linksTableBody) return;
            linksTableBody.innerHTML = '';
            if (!links || links.length === 0) {
                linksTableBody.innerHTML = '<tr><td colspan="3" style="text-align:center;">目前沒有任何綁定資料。</td></tr>';
                return;
            }
            links.forEach(link => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${link.store_name || 'N/A'}</td>
                    <td>${link.user_name || 'N/A'}</td>
                    <td><button class="btn-delete" onclick="deleteLink(${link.link_id})">刪除</button></td>
                `;
                linksTableBody.appendChild(row);
            });
        }

        async function deleteLink(linkId) {
            if (!confirm('確定要刪除此筆綁定關係嗎？')) return;
            try {
                const response = await fetch('/api/store_user_links/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ link_id: linkId })
                });
                const result = await response.json();
                if (response.ok) {
                    alert('刪除成功！');
                    fetchLinks();
                } else {
                    alert(`刪除失敗: ${result.error}`);
                }
            } catch (error) {
                console.error('刪除綁定時發生錯誤:', error);
                alert('刪除失敗，請檢查網路連線。');
            }
        }

        function getPartnerLevelText(level) {
            switch (level) { case 0: return '非合作'; case 1: return '合作'; case 2: return 'VIP'; default: return '未知'; }
        }
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleString('sv-SE').slice(0, 16);
        }

        searchButton.addEventListener("click", () => fetchStores(1));
        searchNameInput.addEventListener("keypress", (event) => {
            if (event.key === "Enter") { event.preventDefault(); searchButton.click(); }
        });
        storeSelect.addEventListener('change', (event) => {
            fetchMenuItems(event.target.value);
        });
        ocrStoreSelect.addEventListener('change', (event) => {
            fetchOcrMenuItems(event.target.value);
        });
        langSearchInput.addEventListener('keypress', (event) => {
            if (event.key === "Enter") { event.preventDefault(); fetchLanguages(); }
        });
        langSearchInput.addEventListener('input', () => fetchLanguages());


        document.addEventListener("DOMContentLoaded", async () => {
            fetchStores(1);
            await populateStoreSelector();

            const urlParams = new URLSearchParams(window.location.search);
            const activeTab = urlParams.get('tab');
            const storeId = urlParams.get('store_id');
            const storeName = urlParams.get('store_name');

            if (activeTab) {
                const tabButton = document.querySelector(`button[onclick*="${activeTab}"]`);
                if (tabButton) {
                    tabButton.click();
                }
            }

            if (activeTab === 'menu' && storeId) {
                storeSelect.value = storeId;
                storeSelect.dispatchEvent(new Event('change'));
            } else if (activeTab === 'ocr' && storeName) {
                await populateOcrStoreSelector(); 
                ocrStoreSelect.value = storeName;
                ocrStoreSelect.dispatchEvent(new Event('change'));
            }
        });
    </script>
</body>
</html>